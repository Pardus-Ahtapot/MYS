---
- name: Konfigurasyon listesi olusturuluyor
  set_fact: conf_list="[ ]"
  when: conf_list is not defined
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Kullanici listesi aliniyor
  sudo: yes
  shell: "cat /etc/passwd | awk -F: '{print $1}' | sort -sf"
  register: user_list
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Grup listesi aliniyor
  sudo: yes
  shell: "cat /etc/group | awk -F: '{print $1}' | sort -sf"
  register: group_list
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Paket listesi aliniyor
  sudo: yes
  shell: "dpkg-query -f '${binary:Package}\n' -W"
  register: package_list
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Konfigurasyon dosyalari listesi duzenleniyor
  set_fact:
    conf_list: "{{ conf_list | unique }}"
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name : Konfigurasyon bilgilerini aliniyor
  stat:
    path: "{{ item }}"
    checksum_algorithm: sha256
    follow: no
    get_md5: no
    get_checksum: yes
  register: stat_results
  with_items: "{{ conf_list }}"
  sudo: yes
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Paket bilgileri aliniyor
  shell: "ls {{ integrity['debsums']['file-pattern'] }}"
  register: debsum_file_list

- name: Paket bilgileri ozet degerleri aliniyor
  stat:
    path: "{{ item }}"
    checksum_algorithm: sha256
    follow: no
    get_md5: no
    get_checksum: yes
  register: debsum_stat_results
  with_items: "{{ debsum_file_list.stdout_lines }}"
  sudo: yes
  tags:
    - integrity
    - integrity-local
    - integrity-remote

- name: Gecici konfigurasyon dizini yerel cihazda olusturuluyor
  file:
    path: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}"
    state: directory
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Konfigurasyon dosyasi yerel cihazda siliniyor
  file:
    path: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/confs"
    state: absent
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Konfigurasyon dosyasi yerel cihazda olusturuluyor
  file:
    path: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/confs"
    state: touch
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Konfigurasyon bilgileri yerel cihaza kaydediliyor
  lineinfile:
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/confs"
    regexp: "^[a-f0-9]* {{ item.stat.path | regex_escape() }}"
    line: "{{ item.stat.checksum }} {{ item.stat.path }}"
  when: item.stat.checksum is defined
  with_items: "{{ stat_results.results }}"
  delegate_to: localhost
  no_log: yes
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Paket bilgileri dosyasi yerel cihazda siliniyor
  file:
    path: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/debsums"
    state: absent
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Paket bilgileri dosyasi yerel cihazda olusturuluyor
  file:
    path: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/debsums"
    state: touch
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Paket bilgileri yerel cihaza kaydediliyor
  lineinfile:
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/debsums"
    regexp: "^[a-f0-9]* {{ item.stat.path | regex_escape() }}"
    line: "{{ item.stat.checksum }} {{ item.stat.path }}"
  when: item.stat.checksum is defined
  with_items: "{{ debsum_stat_results.results }}"
  delegate_to: localhost
  no_log: yes
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Kullanici bilgileri yerel cihaza kaydediliyor
  copy:
    content: "{{ user_list.stdout }}\n"
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/users"
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Grup bilgileri yerel cihaza kaydediliyor
  copy:
    content: "{{ group_list.stdout }}\n"
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/groups"
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Paket bilgileri yerel cihaza kaydediliyor
  copy:
    content: "{{ package_list.stdout }}\n"
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/packages"
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Whitelist dosyalari olusturuluyor
  template:
    src: "integrity-whitelist-{{ item }}.j2"
    dest: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/{{ item }}.whitelist"
    owner: "{{ integrity['files']['local']['owner'] }}"
    group: "{{ integrity['files']['local']['group'] }}"
    mode: "{{ integrity['files']['local']['mode'] }}"
  delegate_to: localhost
  become: yes
  become_user: ahtapotops
  with_items:
    - "users"
    - "groups"
    - "packages"
  when: integrity['whitelist'][inventory_hostname] is defined
  tags:
    - integrity
    - integrity-local

- name: Bilgiler git sunucusuna kaydediliyor
  shell: |
    /usr/bin/git checkout -- .
    /usr/bin/git checkout master
    /usr/bin/git checkout -b {{ item }} || /usr/bin/git checkout {{ item }} || true
    /usr/bin/git reset --hard origin/{{ item }}
    /usr/bin/git clean -fd
    /usr/bin/git pull
    /bin/cp {{ integrity['files']['local']['temp'] }}/{{ item }}/* .
    /bin/chown -R ahtapotops:ahtapotops {{ integrity['files']['local']['temp'] }}/{{ item }}/*
    /usr/bin/git add .
    /usr/bin/git commit -m "{{ item }}"
    /usr/bin/git push --set-upstream origin {{ item }}
  args:
    chdir: "{{ integrity['files']['git']['path'] }}"
  delegate_to: localhost
  with_items: "{{ ansible_play_hosts }}"
  run_once: true
  become: yes
  become_user: ahtapotops
  tags:
    - integrity
    - integrity-local

- name: Konfigurasyon dizini uzak cihazda olusturuluyor
  sudo: yes
  file:
    path: "{{ integrity['files']['remote']['path'] }}"
    mode: "{{ integrity['files']['remote']['mode'] }}"
    state: directory
  tags:
    - integrity
    - integrity-remote

- name: Bilgiler uzak cihaza kaydediliyor
  copy:
    src: "{{ integrity['files']['local']['temp'] }}/{{ inventory_hostname }}/"
    dest: "{{ integrity['files']['remote']['path'] }}/"
    directory_mode: yes
    owner: root
    group: root
  sudo: yes
  tags:
    - integrity
    - integrity-remote