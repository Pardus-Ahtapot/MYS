---
- name: Install ansible
  apt:
    name: "{{item}}"
    state: present
  with_items:
    - ansible
    - git
  sudo: yes
  tags: smartstate


- name: Deploy smartstate script
  template:
    src: "smartstate.py.j2"
    dest: "/opt/ahtapot/smartstate.py"
    owner: "root"
    mode: "755"
  sudo: yes
  tags: smartstate

- name: Set cron configuration
  cron:
    name: "ansible pull script for role {{inventory_hostname}}"
    cron_file: "{{state_ng.host.cron_file}}"
    minute: "{{60 | random}}"
    hour: "{{state_ng.host.cron_hour}}"
    day: "{{state_ng.host.cron_day}}"
    job: "/opt/ahtapot/smartstate.py --smart-pull --host {{inventory_hostname}}"
    state: present
    user: ahtapotops
  when: state_ng.pull_hosts is defined and inventory_hostname in state_ng.pull_hosts
  notify: reload cron
  sudo: yes
  tags: smartstate

- name: Remove cron configuration
  cron:
    name: "ansible pull script for role {{inventory_hostname}}"
    cron_file: "{{state_ng.host.cron_file}}"
    job: "/opt/ahtapot/smartstate.py --smart-pull --host {{inventory_hostname}}"
    state: absent
    user: ahtapotops
  when: state_ng.pull_hosts is defined and inventory_hostname not in state_ng.pull_hosts or state_ng.pull_hosts is not defined
  notify: reload cron
  sudo: yes
  tags: smartstate

- name: Deploy smartstate script on local
  template:
    src: "smartstate.py.j2"
    dest: "/opt/ahtapot/smartstate.py"
    owner: "root"
    mode: "755"
  delegate_to: localhost
  run_once: true
  sudo: yes
  tags: smartstate

- name: Set cron configuration on local
  cron:
    name: "ansible push script"
    cron_file: "{{state_ng.mys.cron_file}}"
    minute: "{{state_ng.mys.cron_minute}}"
    hour: "{{state_ng.mys.cron_hour}}"
    day: "{{state_ng.mys.cron_day}}"
    job: "/opt/ahtapot/smartstate.py --smart-push "
    state: present
    user: ahtapotops
  delegate_to: localhost
  run_once: true
  sudo: yes
  tags: smartstate

- name: Trigger task kontrol degiskeni ayarlaniyor
  shell: /bin/true
  register: skip_trigger
  delegate_to: localhost
  tags: smartstate

- name: Run smartstate trigger
  shell: "((/opt/ahtapot/smartstate.py --pull --host {{inventory_hostname}} 1>/dev/null 2>&1 ) & )"
  when: skip_trigger is not defined
  tags: smartstate,trigger

- name: Run smartstate smart trigger
  shell: "((/opt/ahtapot/smartstate.py --smart-pull --host {{inventory_hostname}} 1>/dev/null 2>&1 ) & )"
  when: skip_trigger is not defined
  tags: smartstate,smarttrigger



