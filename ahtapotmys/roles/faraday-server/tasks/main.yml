---
- name: installing faraday-server
  sudo: yes
  apt:
    name: "{{ item }}"
  with_items:
    - faraday-server

- name: Creating Faraday Database
  sudo: yes
  shell: |
    /usr/share/faraday/server/faraday-util.sh initdb
    sleep 20

- name: Creating Faraday User
  sudo: yes
  shell: |
    /usr/share/faraday/server/faraday-util.sh createsuperuser --username {{faraday_user}} --email {{faraday_email}} --password {{faraday_password}}

- name: Changing Faraday User Password
  sudo: yes
  shell: |
    /usr/share/faraday/server/faraday-util.sh changepassword --username {{faraday_user}} --password {{faraday_password}}

- name: Registering secret_key
  shell: "cat /root/.faraday/config/server.ini | grep \"secret_key\" | awk '{print $3}'"
  register: secret_key

- name: Setting Faraday Config
  sudo: yes
  shell: |
      sed -i "/\[faraday_server\]/,/^$/ s/^port.*/port = {{faraday_port}}/g" /root/.faraday/config/server.ini
      sed -i "/\[faraday_server\]/,/^$/ s/bind_address.*/bind_address = {{faraday_bind_addr}}/g" /root/.faraday/config/server.ini
      sed -i "/\[faraday_server\]/,/^$/ s/websocket_port.*/websocket_port = {{faraday_websoc_port}}/g" /root/.faraday/config/server.ini
      sed -i "/\[ssl\]/,/^$/ s/port.*/port = {{faraday_ssl_port}}/g" /root/.faraday/config/server.ini
      sed -i "/\[ssl\]/,/^$/ s|certificate.*|certificate = {{faraday_ssl_cert}}|g" /root/.faraday/config/server.ini
      sed -i "/\[ssl\]/,/^$/ s|keyfile.*|keyfile = {{faraday_ssl_key}}|g" /root/.faraday/config/server.ini
      sed -i "/\[storage\]/,/^$/ s|path.*|path = {{faraday_storage_path}}|g" /root/.faraday/config/server.ini

- name: configure faraday server-service-options.conf file
  sudo: yes
  template:
    src: "server-service-options.conf.j2"
    dest: "/usr/share/faraday/server/env/server-service-options.conf"
    owner: root
    group: root
    mode: 0644

- name: Check if ssl certificate exists
  sudo: yes
  stat:
    path: "{{faraday_ssl_cert}}"
  register: ssl_exists

- name: Create ssl certificate
  sudo: yes
  shell: |
    cd /etc/ssl/
    openssl genrsa -des3 -passout pass:xxxx -out /etc/ssl/faraday.pass.key 2048
    openssl rsa -passin pass:xxxx -in /etc/ssl/faraday.pass.key -out {{faraday_ssl_key}}
    chmod 600 faraday.key
    rm /etc/ssl/faraday.pass.key
    openssl req -new -key {{faraday_ssl_key}} -out /etc/ssl/faraday.csr -subj "/C={{faraday_ssl_country}}/ST={{faraday_ssl_state}}/L={{faraday_ssl_locality}}/O={{faraday_ssl_organization}}/OU={{faraday_ssl_organizationalunit}}/CN={{faraday_ssl_commonname}}"
    openssl x509 -req -days 3650 -in /etc/ssl/faraday.csr -signkey {{faraday_ssl_key}} -out /etc/ssl/faraday.crt
    openssl rsa -in {{faraday_ssl_key}} -out /etc/ssl/faraday.key.unencrypted
    mv -f faraday.key.unencrypted faraday.key
    openssl req -new -key {{faraday_ssl_key}} -x509 -extensions v3_ca -keyout cakey.pem -out cacert.pem -days 3650 -subj "/C={{faraday_ssl_country}}/ST={{faraday_ssl_state}}/L={{faraday_ssl_locality}}/O={{faraday_ssl_organization}}/OU={{faraday_ssl_organizationalunit}}/CN={{faraday_ssl_commonname}}"
  when: (ssl_exists.stat.exists == False)

- name: restart faraday-server
  sudo: yes
  service:
    name: faraday-server
    enabled: yes
    state: restarted

